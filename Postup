Security

Isiel som podla postupu z lekcie 15.
1.


Synch, download.


2.
Ked som zopakoval dalsi postup


Tak sa ma nespytalo s akou entitou to chcem previazat. Tak som to ignoroval a siel dalej.

Dal som synch a download a skusal dalej. Tu sa hned stala vec co som si neuvedomil ze som daval synch len src a templates ale v tomto pripade bolo treba dat synch vsetko okrem var a vendor.

Ja som medzitym zmenil subor confing/package/security.yaml podla Ludekovho vzoru:
security:
    # https://symfony.com/doc/current/security.html#where-do-users-come-from-user-providers
    encoders:
        App\Entity\User:
            algorithm: bcrypt

    providers:
        in_memory: { memory: ~ }
    firewalls:
        dev:
            pattern: ^/(_(profiler|wdt)|css|images|js)/
            security: false
        main:
            anonymous: true
            guard:
                authenticators:
                    - App\Security\AdminAuthenticator
                logout:
                    path: app_logout


            # activate different ways to authenticate
            # https://symfony.com/doc/current/security.html#firewalls-authentication

            # https://symfony.com/doc/current/security/impersonating_user.html
            # switch_user: true

    # Easy way to control access for large sections of your site
    # Note: Only the *first* access control that matches will be used
    access_control:
         - { path: ^/admin, roles: ROLE_ADMIN }
        # - { path: ^/profile, roles: ROLE_USER }


a az potom som dal synch so vsetkymi subormi okrem var a vendor ale to uz neukazalo nic.

Tak som pokracoval dalej a zistil som ze mam vsetky doteraz vyvorene subory zhodne s Ludekovymi:
SECURITY.YAML
ADMINLOGINCONTROLLER.PHP
USER.PHP
USERREPOSITORY.PHP
ADMINAUTHENTICATOR.PHP
TEMPLATES/SECURITY/LOGIN.HTML.TWIG


Isiel som dalej podla postupu a vytvoril som command
php bin/console make:command

Vznikol error (divne lebo ked som to opakoval tak som error nedostal) lebo moj security.yaml vyzeral takto:
security:
    encoders:
        App\Entity\User:
            algorithm: bcrypt

    # https://symfony.com/doc/current/security.html#where-do-users-come-from-user-providers
    providers:
        # used to reload user from session & other features (e.g. switch_user)
        app_user_provider:
            entity:
                class: App\Entity\User
                property: username
    firewalls:
        dev:
            pattern: ^/(_(profiler|wdt)|css|images|js)/
            security: false
        main:
            anonymous: true
            guard:
                authenticators:
                    - App\Security\AdminAuthenticator
            logout:
                path: app_logout

            # activate different ways to authenticate

            # http_basic: true
            # https://symfony.com/doc/current/security.html#a-configuring-how-your-users-will-authenticate

            # form_login: true
            # https://symfony.com/doc/current/security/form_login_setup.html

    # Easy way to control access for large sections of your site
    # Note: Only the *first* access control that matches will be used
    access_control:
         - { path: ^/admin, roles: ROLE_USER }



ak som ho zmenil podla postupu z lekcie 15 na toto:
security:
    # https://symfony.com/doc/current/security.html#where-do-users-come-from-user-providers
    providers:
        in_memory: { memory: ~ }
    firewalls:
        dev:
            pattern: ^/(_(profiler|wdt)|css|images|js)/
            security: false
        main:
            anonymous: true

            # activate different ways to authenticate
            # https://symfony.com/doc/current/security.html#firewalls-authentication

            # https://symfony.com/doc/current/security/impersonating_user.html
            # switch_user: true

    # Easy way to control access for large sections of your site
    # Note: Only the *first* access control that matches will be used
    access_control:
         - { path: ^/admin, roles: ROLE_ADMIN }
        # - { path: ^/profile, roles: ROLE_USER }


Tak prikaz php bin/console make:command fungoval.
Synch a download.

Lenze moj vytvoreny command a Ludekov sa lisili. Ludekov mal navyse tento kod:
 /** @var UserPasswordEncoderInterface */
private $passwordEncoder;

/** @var EntityManagerInterface */
private $entityManager;

public function __construct(UserPasswordEncoderInterface $passwordEncoder, EntityManagerInterface $entityManager)
{
    $this->passwordEncoder = $passwordEncoder;
    $this->entityManager = $entityManager;
    parent::__construct();
}
Ktory som doplnil do COMMAND/UserCreateCommand.php    co som sa dalej docital v postupe z lekcie15 ze to tam ma byt.

V postupe som mal este premenit funkciu execute v UserCreateCommand.php aby vyzerala takto:

$io = new SymfonyStyle($input, $output);
    $username = $input->getArgument('username');
    $password = $input->getArgument('password');

    $user = new User();
    $user->setUsername($username);
    $user->setPassword(
        $this->passwordEncoder->encodePassword($user, $password)
    );
    $this->entityManager->persist($user);
    $this->entityManager->flush($user);

    $io->success(sprintf('Created user: %s', $username));
}

tak som to tam nakopiroval.
Az ked je takto zmeneny subor USERCREATECOMMAND.php az vtedy je mozno vytvorit uzivatela resp. admina.



Uz ostal len jediny rozdiel a to spravit Controller: AdminControler.php v ktorom mal Ludek:
<?php

namespace App\Controller;

use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Annotation\Route;

/**
 * @Route("/admin")
 */
class AdminController extends AbstractController
{
    /**
     * @Route("/", name="admin_index")
     */
    public function index(): Response
    {
        return $this->redirectToRoute('product_index');
    }
}


Spravil som tento controller skopiroval som donho:
<?php

namespace App\Controller;

use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Annotation\Route;

/**
 * @Route("/admin")
 */
class AdminController extends AbstractController
{
    /**
     * @Route("/", name="admin_index")
     */
    public function index(): Response
    {
        return $this->redirectToRoute('product_index');
    }
}


a vymazal jeho Templats/admin/index.html.twig celu tuto zlozku.

Potom som este mal rozdiely v UserCreateCommand.php
tak som to cele prekopiroval od Ludeka:
<?php

namespace App\Command;

use App\Entity\User;
use Doctrine\ORM\EntityManagerInterface;
use Symfony\Component\Console\Command\Command;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\Console\Style\SymfonyStyle;
use Symfony\Component\Security\Core\Encoder\UserPasswordEncoderInterface;

class UserCreateCommand extends Command
{
    protected static $defaultName = 'user:create';

    /** @var UserPasswordEncoderInterface */
    private $passwordEncoder;

    /** @var EntityManagerInterface */
    private $entityManager;

    public function __construct(UserPasswordEncoderInterface $passwordEncoder, EntityManagerInterface $entityManager)
    {
        $this->passwordEncoder = $passwordEncoder;
        $this->entityManager = $entityManager;
        parent::__construct();
    }

    protected function configure()
    {
        $this
            ->setDescription('Crete new user')
            ->addArgument('u
            sername', InputArgument::REQUIRED)
            ->addArgument('password', InputArgument::REQUIRED)
        ;
    }

    protected function execute(InputInterface $input, OutputInterface $output)
    {
        $io = new SymfonyStyle($input, $output);
        $username = $input->getArgument('username');
        $password = $input->getArgument('password');

        $user = new User();
        $user->setUsername($username);
        $user->setPassword(
            $this->passwordEncoder->encodePassword($user, $password)
        );
        $this->entityManager->persist($user);
        $this->entityManager->flush($user);

        $io->success(sprintf('Created user: %s', $username));
    }
}



Potom som vytvoril uzivatela:
php bin/console user:create admin 1234
lenze toto robilo error.

Musel som naspat prepisat subor config/packages/security.yaml  na:

security:
    encoders:
        App\Entity\User:
            algorithm: bcrypt

    # https://symfony.com/doc/current/security.html#where-do-users-come-from-user-providers
    providers:
        # used to reload user from session & other features (e.g. switch_user)
        app_user_provider:
            entity:
                class: App\Entity\User
                property: username
    firewalls:
        dev:
            pattern: ^/(_(profiler|wdt)|css|images|js)/
            security: false
        main:
            anonymous: true
            guard:
                authenticators:
                    - App\Security\AdminAuthenticator
            logout:
                path: app_logout

            # activate different ways to authenticate

            # http_basic: true
            # https://symfony.com/doc/current/security.html#a-configuring-how-your-users-will-authenticate

            # form_login: true
            # https://symfony.com/doc/current/security/form_login_setup.html

    # Easy way to control access for large sections of your site
    # Note: Only the *first* access control that matches will be used
    access_control:
        - { path: ^/admin, roles: ROLE_USER }



a uz to fungovalo.

Az do okamihu kym som testoval prihlasenie admina na stranke:
http://miroslavmurar.php-kurz.braincraft.cz/PHP/public/login

dostal som error
An exception has been thrown during the rendering of a template ("Unable to generate a URL for the named route "app_logout" as such route does not exist.").

Skusil som nakopirovat od Ludeka base.html.twig do mojho a jeho base.admin.html.twig do mojho sice error zmizol ale objavilo sa:
Warning: unserialize() expects parameter 1 to be string, array given

Ked som vsetko prekopiroval od Ludeka tak som mal error

An exception has been thrown during the rendering of a template ("Unable to generate a URL for the named route "app_logout" as such route does not exist.").

Ak som v base.html.twig vykomentoval errorovy riadok vsetko slo ok.

TO je ale defka !!!!
Ta pica bolo treba este zmenit v config/route.yaml subor. Trebalo tam dopisat
: app_logout:
  path: /logout

aby vyzeral takto:

#index:
#    path: /
#    controller: App\Controller\DefaultController::index
app_logout:
  path: /logout


Inak to je plne funkcna aplikacia s muchami ale funkcna. FINISH PROJEKTU.

